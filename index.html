<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RADSAN TAHLIL | Ø±Ø§Ø¯Ø³Ø§Ù† ØªØ­Ù„ÛŒÙ„</title>
    
    <!-- Meta Tags -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <!-- Fonts -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CORE STYLES --- */
        :root {
            --glass-bg: rgba(15, 23, 42, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --accent-gold: #FFD700;
            --font-main: 'Vazirmatn', sans-serif;
            --bg-color: #000;
        }

        /* Themes */
        body.theme-night { --glass-bg: rgba(2, 6, 23, 0.75); --bg-color: #0f172a; }
        body.theme-day { --glass-bg: rgba(255, 255, 255, 0.95); --text-primary: #1e293b; --bg-color: #f8fafc; }
        body.theme-fantasy { --glass-bg: rgba(45, 10, 60, 0.7); --bg-color: #2e1065; --accent-gold: #f0abfc; }
        body.theme-gold { --glass-bg: rgba(20, 20, 20, 0.85); --bg-color: #000; --accent-gold: #FFD700; }
        body.theme-ultra-luxury { --glass-bg: rgba(0, 0, 0, 0.9); --bg-color: #050505; --accent-gold: #c5a028; border-color: #c5a028; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-primary);
            transition: all 0.5s ease;
            overflow-x: hidden;
        }

        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .theme-ultra-luxury .glass-panel {
            border: 1px solid rgba(197, 160, 40, 0.3);
            box-shadow: 0 0 15px rgba(197, 160, 40, 0.1);
        }

        .gold-title {
            font-family: 'Cinzel', serif;
            background: linear-gradient(to top, #c5a028, #FFD700, #FFF8DC); 
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.3); 
            animation: pulse-glow 3s infinite alternate;
        }

        @keyframes pulse-glow {
            0% { text-shadow: 0 0 10px rgba(255, 215, 0, 0.4); filter: brightness(100%); }
            100% { text-shadow: 0 0 20px rgba(255, 215, 0, 0.8); filter: brightness(130%); }
        }
        
        .update-button-blink {
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            background: rgba(255, 215, 0, 0.1);
            transition: all 0.3s ease;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        .update-button-blink:hover {
            animation: none;
            background: var(--accent-gold);
            color: var(--bg-color); 
        }

        #status-message {
            position: fixed; top: 60px; right: 16px; z-index: 1000;
            opacity: 0; transform: translateX(100%); transition: opacity 0.5s, transform 0.5s;
        }
        #status-message.show { opacity: 1; transform: translateX(0); }
        
        .ticker-wrap { overflow: hidden; white-space: nowrap; width: 100%; }
        .ticker-content { display: inline-block; animation: ticker-move 60s linear infinite; padding-right: 100%; padding-left: 0; }
        @keyframes ticker-move { 0% { transform: translate3d(100%, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        .tilt-card { transform-style: preserve-3d; transition: transform 0.1s ease; }
        .tilt-content { transform: translateZ(30px); }

        /* Traffic Lights */
        .light { border-radius: 50%; box-shadow: 0 0 5px rgba(0, 0, 0, 0.5); width: 12px; height: 12px; opacity: 0.3; transition: all 0.3s; }
        .light.active { opacity: 1; box-shadow: 0 0 8px currentColor; }
        .light.blink { animation: blink-light 0.8s infinite alternate; opacity: 1; }
        
        .light-green { background-color: #10b981; color: #10b981; }
        .light-yellow { background-color: #f59e0b; color: #f59e0b; }
        .light-red { background-color: #ef4444; color: #ef4444; }
        
        @keyframes blink-light { from { opacity: 0.4; } to { opacity: 1; box-shadow: 0 0 15px currentColor; } }

        /* --- Response Styles (Dual Layer) --- */
        .general-response {
            background-color: rgba(30, 41, 59, 0.6); 
            border-right: 4px solid #4F46E5; 
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
            color: #E2E8F0;
        }
        .expert-response {
            background-color: rgba(20, 20, 20, 0.8);
            border-left: 4px solid #CA8A04; 
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            color: #F3F4F6;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: var(--accent-gold); border-radius: 4px; }

        /* --- FIX for word-break in RTL chat messages --- */
        .chat-message-content {
            /* Ensures long words (like URLs or technical terms) break correctly */
            word-wrap: break-word;
            word-break: break-word;
            /* Prevents excessive shrinking and ensures content takes max width */
            max-width: 100%; 
            display: block; /* Important for block formatting context */
        }
    </style>
</head>
<body class="theme-night min-h-screen relative text-right">

    <canvas id="bg-canvas"></canvas>
    <div id="status-message" class="glass-panel p-3 rounded-lg text-xs font-semibold shadow-xl border-yellow-500/50 flex items-center gap-2"></div>

    <!-- Ticker -->
    <div class="glass-panel border-b border-opacity-20 fixed top-0 w-full z-50 h-10 flex items-center bg-black/40 overflow-hidden">
        <div class="ticker-wrap">
            <div class="ticker-content flex gap-8 items-center px-4 text-sm font-mono dir-ltr" id="ticker-data">
                <span class="text-yellow-500 animate-pulse">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¨Ø§Ø²Ø§Ø±Ù‡Ø§ÛŒ Ø¬Ù‡Ø§Ù†ÛŒ...</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 pt-16 pb-24 relative z-10 max-w-7xl">

        <header class="flex flex-col items-center mb-8 relative">
            
            <!-- Theme Switcher - Left -->
            <div class="absolute top-0 left-0 z-50 flex flex-row gap-2 items-center">
                <select id="theme-selector" class="glass-panel px-3 py-2 rounded-lg text-xs outline-none cursor-pointer hover:text-yellow-400 transition bg-transparent text-gray-300 border-white/20">
                    <option value="theme-night">ğŸŒ™ Ø´Ø¨</option>
                    <option value="theme-day">â˜€ï¸ Ø±ÙˆØ²</option>
                    <option value="theme-fantasy">ğŸ¦„ ÙØ§Ù†ØªØ²ÛŒ</option>
                    <option value="theme-gold">ğŸ‘‘ Ø·Ù„Ø§ÛŒÛŒ</option>
                    <option value="theme-ultra-luxury">ğŸ’ ÙÙˆÙ‚ Ù„Ø§Ú©Ú†Ø±ÛŒ</option>
                </select>
            </div>

            <!-- Refresh Button - Right -->
            <div class="absolute top-0 right-0 z-50 flex flex-row gap-2 items-center">
                <button id="update-refresh-btn" onclick="handleSoftRefresh()" 
                        class="update-button-blink rounded-lg outline-none transition font-semibold text-xs px-2 py-1">
                    <i class="fas fa-redo-alt ml-1"></i> Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                </button>
            </div>

            <h1 class="text-3xl md:text-4xl font-bold gold-title mb-2 tracking-wider mt-6 text-center">RADSAN TAHLIL</h1>
            
            <!-- NEW: Contact Info -->
            <div class="text-center mb-6 pb-2 border-b border-white/10 w-full max-w-lg">
                <p class="text-yellow-400 font-bold mb-1 text-sm md:text-base">Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒ Ø³ÙˆØ§Ù„Ø§Øª Ø´Ù…Ø§ Ø¯Ø± ØªÙ„Ú¯Ø±Ø§Ù… Ùˆ ÙˆØ§ØªØ³Ø§Ù¾ Ù‡Ø³ØªÙ…</p>
                <div class="flex justify-center gap-4 dir-ltr font-mono text-gray-300 text-sm">
                    <a href="tel:09138665345" class="hover:text-white transition">0913-866-5345</a>
                    <span>|</span>
                    <a href="tel:09367052101" class="hover:text-white transition">0936-705-2101</a>
                </div>
            </div>

            <p class="text-sm md:text-md text-gray-500 font-mono border-b border-white/10 pb-4">STRATEGIC MARKET ANALYZER V7.2</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full max-w-4xl mt-2">
                <!-- Market Cap -->
                <div class="glass-panel rounded-2xl p-4 flex flex-col justify-center">
                    <div class="flex items-center justify-between">
                        <div class="text-xs text-gray-400 mb-1">Ù…Ø§Ø±Ú©Øª Ú©Ù¾ Ú©Ù„ (Top 50)</div>
                        <div class="text-xl font-bold text-white dir-ltr" id="global-mcap">Loading...</div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1" id="mcap-change">...</div>
                </div>

                <!-- Fear & Greed -->
                <div class="glass-panel rounded-2xl p-4 flex flex-col items-center justify-center relative overflow-hidden">
                    <div class="text-[10px] text-gray-400 mb-2 uppercase tracking-wider">Ø§Ø­Ø³Ø§Ø³Ø§Øª Ø¨Ø§Ø²Ø§Ø±</div>
                    <div class="text-5xl font-bold font-mono text-white mb-2" id="fng-value">--</div>
                    <div class="text-xs font-bold px-3 py-1 rounded-full mb-3" id="fng-text">Loading</div>
                    <div class="flex gap-3 justify-center bg-black/30 px-4 py-2 rounded-full border border-white/10" id="fng-lights-container"></div>
                </div>

                <!-- Dominance -->
                <div class="glass-panel rounded-2xl p-4 flex flex-col justify-center gap-3">
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-gray-400"><i class="fab fa-bitcoin text-yellow-500 mr-1"></i>BTC Dom</span>
                            <span class="text-xs font-bold text-white dir-ltr" id="btc-dom">--%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-1"><div class="bg-yellow-500 h-1 rounded-full transition-all duration-1000" style="width: 0%" id="btc-dom-bar"></div></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-gray-400"><i class="fab fa-ethereum text-blue-400 mr-1"></i>ETH Dom</span>
                            <span class="text-xs font-bold text-white dir-ltr" id="eth-dom">--%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-1"><div class="bg-blue-400 h-1 rounded-full transition-all duration-1000" style="width: 0%" id="eth-dom-bar"></div></div>
                    </div>
                </div>
            </div>
        </header>

        <section class="mb-12">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-yellow-400 border-b border-white/10 pb-2">
                <i class="fas fa-crosshairs"></i> Ø¯ÛŒØ¯Ø¨Ø§Ù† Ù‡ÙˆØ´Ù…Ù†Ø¯ (Smart Watchlist)
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="quick-grid"></div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-12">
            <div class="lg:col-span-2 glass-panel rounded-2xl p-1 min-h-[550px] flex flex-col relative overflow-hidden group">
                <div class="absolute top-4 right-4 z-10 bg-black/50 px-3 py-1 rounded text-xs text-yellow-500 pointer-events-none">
                    <i class="fas fa-chart-line ml-1"></i> TradingView
                </div>
                <div class="tradingview-widget-container flex-grow h-full w-full rounded-xl overflow-hidden" id="tv_chart_container"></div>
            </div>

            <div id="ai-section" class="lg:col-span-1 glass-panel rounded-2xl p-4 flex flex-col h-[600px] lg:h-auto border border-yellow-500/30 shadow-[0_0_20px_rgba(255,215,0,0.1)] relative">
                <div class="border-b border-white/10 pb-4 mb-2 flex items-center justify-between">
                    <div>
                        <h3 class="font-bold text-xl gold-title text-xl" style="font-family: 'Cinzel', serif;">RADSAN AI V7</h3>
                        <p class="text-[10px] text-gray-400">Strategic Core: Dual-Layer Analysis</p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-yellow-400 to-red-600 flex items-center justify-center animate-pulse shadow-lg shadow-yellow-500/20">
                        <i class="fas fa-brain text-white text-lg"></i>
                    </div>
                </div>

                <div id="chat-messages" class="flex-grow overflow-y-auto mb-4 space-y-4 pr-1 pl-1 scroll-smooth">
                    <div class="bg-white/5 p-4 rounded-xl rounded-tr-none border border-white/5 backdrop-blur-sm">
                        <p class="text-sm leading-7">
                            ğŸ‘‹ Ø³Ù„Ø§Ù…! Ù…Ù† <span class="text-yellow-400 font-bold">RADSAN V7</span> Ù‡Ø³ØªÙ….
                        </p>
                        <div class="text-xs mt-2 text-gray-400 text-justify leading-5 border-r-2 border-yellow-500 pr-2">
                            <b>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ (Û±Û¶ Ø¯Ø³Ø§Ù…Ø¨Ø±):</b>
                            <br>â€¢ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§Ø²Ø§Ø±: <span class="text-red-400">Ù†Ø²ÙˆÙ„ÛŒ (Bearish)</span> Ø¨Ø§ Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ø±ÛŒØ²Ø´.
                            <br>â€¢ Ø§Ù‡Ø¯Ø§Ù Ø¨ÛŒØªâ€ŒÚ©ÙˆÛŒÙ†: <span class="text-yellow-300">Û¸Û°k Ùˆ Û·Û´k</span> Ø¯Ù„Ø§Ø±.
                            <br>â€¢ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø®Ø±ÙˆØ¬ Ù¾Ù„Ù‡â€ŒØ§ÛŒ ÛŒØ§ Ù¾ÙˆØ²ÛŒØ´Ù† Short Ø¯Ø± Ø±ÛŒØªØ³Øªâ€ŒÙ‡Ø§.
                        </div>
                    </div>
                </div>

                <div class="relative mt-auto">
                    <input type="text" id="chat-input" placeholder="Ù†Ø§Ù… Ø§Ø±Ø² (Ù…Ø«Ù„Ø§: Ø¨ÛŒØªÚ©ÙˆÛŒÙ†ØŒ Ø·Ù„Ø§)..." 
                           class="w-full bg-black/40 border border-white/20 rounded-xl py-4 px-4 pl-12 text-white placeholder-gray-500 focus:outline-none focus:border-yellow-500 focus:bg-black/60 transition text-sm">
                    <button onclick="handleManualQuery()" class="absolute left-2 top-1/2 transform -translate-y-1/2 w-10 h-10 rounded-full bg-gradient-to-r from-yellow-600 to-yellow-400 hover:from-yellow-500 hover:to-yellow-300 flex items-center justify-center text-black shadow-lg transition solar-btn">
                        <i class="fas fa-search-dollar text-sm"></i>
                    </button>
                </div>
            </div>
        </div>

        <section class="mb-12">
            <div class="glass-panel rounded-xl overflow-hidden">
                <button onclick="toggleAccordion('top40')" class="w-full p-5 flex justify-between items-center hover:bg-white/5 transition solar-btn">
                    <span class="font-bold text-lg flex items-center gap-2">
                        <span class="bg-yellow-500 text-black text-xs px-2 py-0.5 rounded animate-pulse">Live</span>
                        Û´Û° Ø§Ø±Ø² Ø¨Ø±ØªØ± Ø¨Ø§Ø²Ø§Ø±
                    </span>
                    <i class="fas fa-chevron-down transition-transform text-gray-400" id="top40-icon"></i>
                </button>
                <div id="top40-content" class="hidden border-t border-white/10 bg-black/20">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-center border-collapse">
                            <thead class="bg-white/5 text-yellow-500/80 font-normal">
                                <tr>
                                    <th class="p-4 font-normal text-xs">Ø±ØªØ¨Ù‡</th>
                                    <th class="p-4 font-normal text-xs text-right">Ù†Ø§Ù… Ø§Ø±Ø²</th>
                                    <th class="p-4 font-normal text-xs">Ù‚ÛŒÙ…Øª</th>
                                    <th class="p-4 font-normal text-xs">Û²Û´ Ø³Ø§Ø¹Øª</th>
                                    <th class="p-4 font-normal text-xs">ÙˆØ¶Ø¹ÛŒØª Ù‡ÙˆØ´Ù…Ù†Ø¯</th>
                                    <th class="p-4 font-normal text-xs">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="top40-table-body" class="divide-y divide-white/5">
                                <tr><td colspan="6" class="p-8 text-gray-500 animate-pulse">Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³Ú©Ù† Ù…Ø§Ø±Ú©Øª...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section class="mb-12 flex justify-center perspective-container">
            <div class="tilt-card glass-panel w-full max-w-2xl p-8 rounded-3xl border border-yellow-500/40 relative overflow-hidden group cursor-pointer shadow-[0_20px_50px_rgba(0,0,0,0.5)]" id="promo-card">
                <div class="absolute -inset-1 bg-gradient-to-r from-yellow-600 to-purple-600 rounded-3xl blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
                <div class="tilt-content text-center relative z-10 bg-black/40 p-6 rounded-2xl backdrop-blur-xl border border-white/10 h-full">
                    <div class="w-16 h-16 mx-auto bg-gradient-to-br from-yellow-400 to-pink-500 rounded-2xl flex items-center justify-center mb-4 shadow-lg transform group-hover:rotate-12 transition">
                        <i class="fas fa-palette text-2xl text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold mb-2 text-white">Ø®Ø¯Ù…Ø§Øª ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§ Ùˆ Ø·Ø±Ø§Ø­ÛŒ</h3>
                    <p class="text-gray-400 mb-6 text-sm leading-relaxed max-w-md mx-auto">
                        Ø®Ø¯Ù…Ø§Øª ØªØ®ØµØµÛŒ Ú¯Ø±Ø§ÙÛŒÚ©ØŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ùˆ Ø·Ø±Ø§Ø­ÛŒ ÙˆØ¨.
                        <br><span class="text-yellow-500 text-xs">@TASVIRETO</span>
                    </p>
                    <a href="https://t.me/TASVIRETO" target="_blank" class="inline-flex items-center bg-white text-black hover:bg-yellow-400 px-6 py-2.5 rounded-full transition font-bold text-sm solar-btn shadow-lg">
                        <i class="fab fa-telegram ml-2 text-lg"></i> ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯
                    </a>
                </div>
            </div>
        </section>

        <footer class="text-center text-xs text-gray-600 border-t border-white/5 pt-8 pb-4">
            <p class="mb-1 text-gray-500">Ø·Ø±Ø§Ø­ÛŒ Ùˆ ØªÙˆØ³Ø¹Ù‡: <span class="text-yellow-600 font-bold">Ø±Ø§Ø¯Ù…Ù‡Ø± ÙØ±ÙˆØºÛŒ</span></p>
            <p class="opacity-30 dir-ltr font-mono">V7.2 Strategic Core</p>
        </footer>
    </div>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        // ØªÙˆØ¬Ù‡: Ø§ÛŒÙ† Ù…ØªØºÛŒØ± Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø± Ø¯Ø± Ù…Ø­ÛŒØ· Canvas Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.
        // Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¯Ø± Ù‡Ø§Ø³Øª Ø¹Ù…ÙˆÙ…ÛŒ (Ù…Ø§Ù†Ù†Ø¯ GitHub Pages)ØŒ Ø¨Ø§ÛŒØ¯ Ú©Ù„ÛŒØ¯ API Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯:
        // Ù…Ø«Ø§Ù„: const API_KEY = "YOUR_GEMINI_API_KEY_HERE";
      fetch("/api/ai", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    query: "ØªØ­Ù„ÛŒÙ„ Ø¨ÛŒØªÚ©ÙˆÛŒÙ† Ø¯Ø± ÛŒÚ© Ù…Ø§Ù‡ Ø§Ø®ÛŒØ±",
    systemPrompt: "ØªÙˆ ÛŒÚ© ØªØ­Ù„ÛŒÙ„Ú¯Ø± Ø­Ø±ÙÙ‡ Ø§ÛŒ Ù‡Ø³ØªÛŒ"
  })
})
.then(response => response.json())
.then(data => {
  console.log("Ù¾Ø§Ø³Ø® Gemini:", data);

  const answer = data.candidates?.[0]?.content?.parts?.[0]?.text;
  console.log("Ù¾Ø§Ø³Ø® Ù†Ù‡Ø§ÛŒÛŒ:", answer);
})
.catch(error => {
  console.error("Ø®Ø·Ø§:", error);
});

        const CONFIG = { apiRefreshRate: 15000, defaultSymbol: 'BTCUSD', theme: 'theme-night' };
        let marketData = [];
        let binancePrices = {}; 
        let globalTime = 0; 
        let goldData = { price: 2700, change: 0 }; 

        const MOCK_MARKET_DATA = [
            { id: 'bitcoin', name: 'Bitcoin', symbol: 'btc', current_price: 86200.00, price_change_percentage_24h: -1.2, market_cap: 1700000000000, image: 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png' },
            { id: 'ethereum', name: 'Ethereum', symbol: 'eth', current_price: 3105.00, price_change_percentage_24h: -2.5, market_cap: 370000000000, image: 'https://assets.coingecko.com/coins/images/279/large/ethereum.png' },
            { id: 'solana', name: 'Solana', symbol: 'sol', current_price: 130.50, price_change_percentage_24h: -3.8, market_cap: 60000000000, image: 'https://assets.coingecko.com/coins/images/4128/large/solana.png' }
        ];
        const MOCK_FNG_DATA = { data: [{ value: "21", value_classification: "Fear" }] };

        // --- Core Functions (Unchanged) ---
        function updateChart(s) {
            if (typeof TradingView !== 'undefined') {
                new TradingView.widget({ "width": "100%", "height": "100%", "symbol": s, "interval": "D", "timezone": "Asia/Tehran", "theme": "dark", "style": "1", "locale": "en", "toolbar_bg": "#f1f3f6", "enable_publishing": false, "hide_side_toolbar": false, "allow_symbol_change": true, "container_id": "tv_chart_container" });
            } else {
                console.warn("TradingView library not loaded yet.");
            }
        }

        function safeToFixed(value, digits = 2) {
            const num = parseFloat(value);
            if (isNaN(num) || value === null || value === undefined) return (0).toFixed(digits);
            return num.toFixed(digits);
        }

        async function handleSoftRefresh() {
            const button = document.getElementById('update-refresh-btn');
            button.disabled = true; button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            const success = await fetchMarketData();
            button.disabled = false; button.innerHTML = '<i class="fas fa-redo-alt ml-1"></i> Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ';
            const msg = success ? 'Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯Ù†Ø¯.' : 'Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† ÙØ¹Ø§Ù„ Ø´Ø¯. Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ­Ù„ÛŒÙ„â€ŒØ´Ø¯Ù‡.';
            showStatusMessage(msg, success ? 'success' : 'info');
        }

        async function fetchWithRetry(url, options = {}, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                    // Throw a specific error for non-ok responses (that aren't retries)
                    if (response.status === 429 || response.status >= 500) {
                        throw new Error(`Retry HTTP Error: ${response.status}`);
                    }
                    throw new Error(`HTTP Error: ${response.status}`);
                } catch (error) {
                    if (i < retries - 1 && error.message.startsWith('Retry')) {
                        // Only retry for 429 and 5xx errors
                        await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                    } else {
                        // Throw immediately for non-retriable errors or after max retries
                        throw error;
                    }
                }
            }
        }

        function showStatusMessage(message, type = 'success') {
            const msgBox = document.getElementById('status-message');
            msgBox.innerHTML = ''; 
            let iconClass = type === 'success' ? 'fas fa-check-circle text-green-400' : 'fas fa-exclamation-triangle text-yellow-400';
            let bgColor = type === 'success' ? 'bg-green-900/40' : 'bg-yellow-900/40';
            msgBox.className = `glass-panel p-3 rounded-lg text-xs font-semibold shadow-xl border-yellow-500/50 flex items-center gap-2 show ${bgColor}`;
            msgBox.innerHTML = `<i class="${iconClass}"></i><span>${message}</span>`;
            setTimeout(() => { msgBox.classList.remove('show'); }, 4000);
        }

        const initThreeJS = () => {
            const canvas = document.getElementById('bg-canvas');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0xffd700, 0.8);
            pointLight.position.set(10, 10, 10);
            scene.add(pointLight);
            const coins = [];
            const geometry = new THREE.DodecahedronGeometry(1.5); 
            const material = new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.9, roughness: 0.2, transparent: true, opacity: 0.2 });
            for (let i = 0; i < 20; i++) {
                const coin = new THREE.Mesh(geometry, material);
                coin.position.set((Math.random()-0.5)*40, (Math.random()-0.5)*40, (Math.random()-0.5)*20-5);
                coin.userData = { initialY: coin.position.y, floatSpeed: (Math.random()*0.2)+0.05, floatRange: (Math.random()*2)+1.5, rotSpeedX: (Math.random()-0.5)*0.002, rotSpeedY: (Math.random()-0.5)*0.002, timeOffset: Math.random()*Math.PI*2 };
                scene.add(coin);
                coins.push(coin);
            }
            camera.position.z = 15;
            const animate = () => {
                requestAnimationFrame(animate);
                globalTime += 0.005;
                coins.forEach(coin => {
                    coin.rotation.x += coin.userData.rotSpeedX;
                    coin.rotation.y += coin.userData.rotSpeedY;
                    coin.position.y = coin.userData.initialY + Math.sin(globalTime * coin.userData.floatSpeed + coin.userData.timeOffset) * coin.userData.floatRange;
                    coin.position.z += Math.sin(globalTime * 0.5 + coin.userData.timeOffset) * 0.001;
                });
                renderer.render(scene, camera);
            };
            animate();
            window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        };

        function getSignalStatus(coin) {
            const c24 = coin.price_change_percentage_24h || 0;
            const c7d = coin.price_change_percentage_7d_in_currency || c24;
            const long = (c7d > 5 || (c7d > 0 && c24 > 2)) ? 'green' : (c7d < -5 ? 'red' : 'yellow');
            const mid = c24 > 1.5 ? 'green' : (c24 < -1.5 ? 'red' : 'yellow');
            const short = (c24 > 3) ? 'green' : (c24 < -3 ? 'red' : 'yellow');
            return { long, mid, short };
        }

        function generateTrafficLightsHTML(coin, isSmall=false) {
            const s = getSignalStatus(coin);
            const sz = isSmall ? 'w-2 h-2' : 'w-3 h-3';
            const col = (c) => c==='green'?'light-green':c==='red'?'light-red':'light-yellow';
            return `<div class="flex gap-1.5 justify-center"><div class="light ${col(s.long)} active ${sz}"></div><div class="light ${col(s.mid)} active ${sz}"></div><div class="light ${col(s.short)} active blink ${sz}"></div></div>`;
        }

        async function fetchMarketData() {
            let success = true;
            try {
                // Attempt fetch, but handle failure gracefully without error log
                const response = await fetchWithRetry('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=50&page=1&sparkline=false&price_change_percentage=1h,24h,7d');
                const data = await response.json();
                marketData = data;
                
                try {
                    const goldRes = await fetchWithRetry('https://api.coingecko.com/api/v3/simple/price?ids=pax-gold&vs_currencies=usd&include_24hr_change=true');
                    const gData = await goldRes.json();
                    if(gData['pax-gold']) {
                        const price = gData['pax-gold'].usd;
                        const change = gData['pax-gold'].usd_24h_change;
                        goldData = { 
                            price: (typeof price === 'number' && isFinite(price) ? price : 2700),
                            change: (typeof change === 'number' && isFinite(change) ? change : 0)
                        };
                    }
                } catch(e) { 
                    // Silent catch for Gold
                }

                await updateGlobalStats(data);
            } catch (error) {
                // SILENTLY FALLBACK to Mock Data to avoid console errors
                marketData = MOCK_MARKET_DATA;
                goldData = { price: 2685, change: 0.5 }; // Synced with video
                await updateGlobalStats(marketData, true); // Force mock stats
                success = false;
            }
            updateTicker(marketData);
            updateTop40(marketData);
            renderQuickGrid(marketData);
            return success;
        }

        async function updateGlobalStats(data, forceMock = false) {
            if (!forceMock) {
                try {
                    const fngRes = await fetchWithRetry('https://api.alternative.me/fng/');
                    const fngData = await fngRes.json();
                    updateFearGreedGauge(fngData.data[0].value);
                } catch (error) {
                    updateFearGreedGauge(MOCK_FNG_DATA.data[0].value);
                }
            } else {
                updateFearGreedGauge(MOCK_FNG_DATA.data[0].value);
            }
            
            if (data && data.length > 0) {
                const totalCap = data.reduce((s, c) => s + (c.market_cap || 0), 0); 
                const btc = data.find(c => c.symbol === 'btc');
                const eth = data.find(c => c.symbol === 'eth');
                
                let btcDom = 59.1; // Default
                let ethDom = 13.2; // Default

                if (btc && eth && totalCap > 0) {
                    btcDom = (btc.market_cap || 0) / totalCap * 100;
                    ethDom = (eth.market_cap || 0) / totalCap * 100;
                }

                document.getElementById('btc-dom').innerText = isFinite(btcDom) ? btcDom.toFixed(1) + "%" : "--%";
                document.getElementById('eth-dom').innerText = isFinite(ethDom) ? ethDom.toFixed(1) + "%" : "--%";
                document.getElementById('btc-dom-bar').style.width = Math.min(isFinite(btcDom) ? btcDom : 0, 100) + "%";
                document.getElementById('eth-dom-bar').style.width = Math.min(isFinite(ethDom) ? ethDom : 0, 100) + "%";

                const globalCapValue = (totalCap / 1e12);
                document.getElementById('global-mcap').innerText = "$" + (isFinite(globalCapValue) ? globalCapValue.toFixed(2) : '--') + "T";
                document.getElementById('mcap-change').innerText = "..."; 
            }
        }

        function updateFearGreedGauge(value) {
            const val = parseInt(value);
            document.getElementById('fng-value').innerText = val;
            const textEl = document.getElementById('fng-text');
            const lightsContainer = document.getElementById('fng-lights-container');
            
            let colorClass = "", text = "";
            let l1 = "opacity-30", l2 = "opacity-30", l3 = "opacity-30"; 
            
            if (val <= 20) { 
                colorClass = "bg-[#ef4444] text-white"; text = "ØªØ±Ø³ Ø´Ø¯ÛŒØ¯";
                l1 = "light-red active"; // Red Solid
            } else if (val <= 35) {
                colorClass = "bg-[#f97316] text-white"; text = "ØªØ±Ø³";
                l1 = "light-red blink"; // Red Blink
            } else if (val <= 45) {
                colorClass = "bg-[#eab308] text-black"; text = "Ø®Ù†Ø«ÛŒ";
                l2 = "light-yellow blink"; // Yellow Blink
            } else if (val <= 55) {
                colorClass = "bg-[#eab308] text-black"; text = "Ø®Ù†Ø«ÛŒ Ù…Ø·Ù„Ù‚";
                l2 = "light-yellow active"; // Yellow Solid
            } else if (val <= 78) {
                colorClass = "bg-[#22c55e] text-white"; text = "Ø·Ù…Ø¹";
                l3 = "light-green blink"; // Green Blink
            } else {
                colorClass = "bg-[#22c55e] text-white"; text = "Ø·Ù…Ø¹ Ø´Ø¯ÛŒØ¯";
                l3 = "light-green active"; // Green Solid
            }
            
            textEl.innerText = text;
            textEl.className = `text-xs font-bold px-3 py-1 rounded-full mb-3 ${colorClass}`;
            lightsContainer.innerHTML = `<div class="light ${l1}"></div><div class="light ${l2}"></div><div class="light ${l3}"></div>`;
        }

        function updateTicker(data) {
            const el = document.getElementById('ticker-data');
            // Gold Data
            const gPriceValue = goldData.price || 0;
            const gPrice = gPriceValue.toLocaleString('en-US', {style:'currency', currency:'USD', minimumFractionDigits: 0});
            const gChangeValue = goldData.change;
            const gChange = typeof gChangeValue === 'number' && isFinite(gChangeValue) ? gChangeValue : 0; 
            const gCol = gChange >= 0 ? 'text-green-400' : 'text-red-400';
            const gArrow = gChange >= 0 ? 'â–²' : 'â–¼';

            let h = `<span class="mx-6 flex items-center gap-2 border-l border-white/20 pl-6 cursor-pointer" onclick="activateAnalysis('Ø·Ù„Ø§', 'XAUUSD', null)"><span class="text-yellow-500 font-bold">ğŸ¥‡ GOLD</span><span class="text-white">${gPrice}</span><span class="${gCol} text-xs">(${gArrow}${safeToFixed(Math.abs(gChange))})</span></span>`;
            
            // Crypto Data
            data.slice(0, 15).forEach(c => {
                const priceChange = c.price_change_percentage_24h || 0;
                const currentPrice = c.current_price || 0;
                const col = priceChange >= 0 ? 'text-green-400' : 'text-red-400';
                const arr = priceChange >= 0 ? 'â–²' : 'â–¼';
                h += `<span class="mx-6 flex items-center gap-2 cursor-pointer" onclick="activateAnalysis('${c.name}', '${c.symbol}', null)"><span class="font-bold text-white">${c.symbol.toUpperCase()}</span><span class="text-white opacity-80">$${currentPrice.toLocaleString()}</span><span class="${col} text-xs">(${arr}${safeToFixed(Math.abs(priceChange))}%)</span></span>`;
            });
            el.innerHTML = h + h;
        }

        function updateTop40(data) {
            const b = document.getElementById('top40-table-body');
            b.innerHTML = '';
            data.slice(0, 40).forEach((c, i) => {
                const lights = generateTrafficLightsHTML(c, true);
                const ch = c.price_change_percentage_24h || 0;
                const col = ch >= 0 ? 'text-green-400' : 'text-red-400';
                b.innerHTML += `<tr class="hover:bg-white/5 transition cursor-pointer border-b border-white/5" onclick="activateAnalysis('${c.name}', '${c.symbol}', null)"><td class="p-3 text-gray-500 text-xs">${i+1}</td><td class="p-3"><div class="flex items-center gap-3 justify-end"><span class="font-bold text-gray-200">${c.name}</span><span class="text-xs text-gray-500">${c.symbol.toUpperCase()}</span><img src="${c.image}" class="w-6 h-6 rounded-full" onerror="this.src='https://placehold.co/20'"></div></td><td class="p-3 font-mono text-gray-300 dir-ltr">$${(c.current_price||0).toLocaleString()}</td><td class="p-3 font-mono dir-ltr ${col}">${safeToFixed(ch)}%</td><td class="p-3">${lights}</td><td class="p-3"><button class="text-[10px] border border-white/20 hover:bg-yellow-500 hover:text-black px-3 py-1 rounded-full">ØªØ­Ù„ÛŒÙ„</button></td></tr>`;
            });
        }

        function renderQuickGrid(data) {
            const g = document.getElementById('quick-grid');
            g.innerHTML = '';
            const assets = [
                {id:'btc',n:'Bitcoin',s:'btc', bs:'BTCUSDT'},
                {id:'eth',n:'Ethereum',s:'eth', bs:'ETHUSDT'},
                {id:'sol',n:'Solana',s:'sol', bs:'SOLUSDT'},
                {id:'xrp',n:'Ripple',s:'xrp', bs:'XRPUSDT'},
                {id:'doge',n:'Dogecoin',s:'doge', bs:'DOGEUSDT'},
                {id:'ada',n:'Cardano',s:'ada', bs:'ADAUSDT'},
                {id:'link',n:'Chainlink',s:'link', bs:'LINKUSDT'}
            ];
            
            const gPrice = (goldData.price || 0).toLocaleString('en-US', {style:'currency', currency:'USD', minimumFractionDigits: 0});
            // Manual Gold Lights (Based on Bullish Strategy)
            const gLights = `<div class="flex gap-1.5 justify-center"><div class="light light-green active w-2 h-2"></div><div class="light light-green active w-2 h-2"></div><div class="light light-yellow active blink w-2 h-2"></div></div>`;
            g.innerHTML += `<div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center gap-2 hover:bg-yellow-900/20 transition cursor-pointer solar-btn transform active:scale-95 border border-yellow-500/30" onclick="activateAnalysis('Gold', 'XAUUSD', null)"><div class="w-12 h-12 mx-auto rounded-full mb-1 shadow-lg bg-gradient-to-br from-yellow-300 to-yellow-600 flex items-center justify-center text-black text-2xl animate-pulse">ğŸ¥‡</div><div class="font-bold text-sm text-yellow-400">GOLD XAU</div><div class="text-xs font-mono text-gray-400">${gPrice}</div><div class="mt-2 scale-90">${gLights}</div></div>`;

            assets.forEach(a => {
                const c = data.find(x => x.symbol === a.s);
                if(c) {
                    const l = generateTrafficLightsHTML(c, false);
                    let price = c.current_price || 0;
                    g.innerHTML += `<div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center gap-2 hover:bg-white/10 transition cursor-pointer solar-btn transform active:scale-95" onclick="activateAnalysis('${c.name}', '${c.symbol}', null)"><img src="${c.image}" class="w-10 h-10 rounded-full mb-1" onerror="this.src='https://placehold.co/40'"><div class="font-bold text-sm text-gray-200">${c.name}</div><div class="text-xs font-mono text-gray-400">$${price.toLocaleString()}</div><div class="mt-2 scale-90">${l}</div></div>`;
                }
            });
        }

        function activateAnalysis(name, symbol, coinData) {
            const sym = symbol ? symbol.toUpperCase() + 'USD' : (name.toUpperCase().includes('GOLD') ? 'XAUUSD' : 'BTCUSD');
            updateChart(sym);
            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('ai-section').scrollIntoView({behavior: 'smooth', block: 'center'});
            document.getElementById('chat-input').value = name;
            handleQueryLogic(name);
        }

        function handleManualQuery() {
            const n = document.getElementById('chat-input').value.trim();
            if(n) {
                document.getElementById('chat-messages').innerHTML = '';
                const c = marketData.find(x => x.name.toLowerCase().includes(n.toLowerCase()) || x.symbol.includes(n.toLowerCase()));
                const sym = c ? c.symbol.toUpperCase()+'USD' : (n.toLowerCase().includes('gold')||n.includes('Ø·Ù„Ø§') ? 'XAUUSD' : 'BTCUSD');
                updateChart(sym);
                handleQueryLogic(n);
            }
        }

        function handleQueryLogic(name) {
            addChatMessage(`Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªØ­Ù„ÛŒÙ„ Ø¨Ø±Ø§ÛŒ: <b>${name}</b>`, 'user');
            const loadingId = addChatMessage(`Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø·ÙˆØ­ Ú©Ù„Ø§Ù† Ùˆ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ FVG...`, 'ai', true);
            
            // Call Gemini API with Grounding
            fetchGeminiAnalysis(name, loadingId);
        }

        // --- UPDATED: Gemini API Integration for External Hosting Fix (V7.2) ---
        async function fetchGeminiAnalysis(query, loadingId) {
            const systemPrompt = `
                Ø´Ù…Ø§ ØªØ­Ù„ÛŒÙ„Ú¯Ø± Ø§Ø±Ø´Ø¯ Ø¨Ø§Ø²Ø§Ø±Ù‡Ø§ÛŒ Ù…Ø§Ù„ÛŒ Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒâ€ŒÙ‡Ø§ÛŒ "Ø¢Ø±Ø²Ø¯ÛŒØ¬ÛŒØªØ§Ù„" (Arzdigital321) ØªØ­Ù„ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯.
                // ... (rest of the system prompt is unchanged for brevity)
            `;

            // V7.2 FIX: Check if API Key is empty (as it is on external public hosts)
            if (API_KEY === "") {
                const el = document.getElementById(loadingId);
                if(el) el.remove();
                addChatMessage(`
                    <div class="p-4 bg-red-900/40 rounded-lg border border-red-500/50">
                        <p class="font-bold text-red-300">ğŸš¨ Ø®Ø·Ø§ÛŒ Ú©Ù„ÛŒØ¯ API (Public Hosting)</p>
                        <p class="text-sm text-red-400 mt-2 text-justify">
                            Ø§ÛŒÙ† Ù…Ø´Ú©Ù„ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ <span class="font-bold text-yellow-300">Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯Ù† Ú©Ù„ÛŒØ¯ API</span> Ø¯Ø± Ù…Ø­ÛŒØ· Ø¹Ù…ÙˆÙ…ÛŒ (Ù…Ø§Ù†Ù†Ø¯ GitHub Pages) Ø§Ø³Øª. 
                            Ù„Ø·ÙØ§Ù‹ Ø¨Ø±Ø§ÛŒ Ø­Ù„ Ù…Ø´Ú©Ù„ØŒ Ú©Ù„ÛŒØ¯ API Ø¬ÙÙ…ÛŒÙ†Ø§ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ø®Ø· <code class="bg-black/40 p-0.5 rounded dir-ltr text-xs">const API_KEY = "";</code> Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ÛŒ ØªÚ¯ <code class="bg-black/40 p-0.5 rounded text-xs dir-ltr">&lt;script&gt;</code> ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.
                        </p>
                    </div>
                `, 'ai');
                return;
            }

            const apiUrl = GEMINI_API_URL + API_KEY;
            const userQuery = `ØªØ­Ù„ÛŒÙ„ Ú©Ø§Ù…Ù„ Ùˆ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø² ${query} Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø¨Ø§Ø²Ø§Ø±.`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }, 3);

                const result = await response.json();
                let text = "Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ ØªØ­Ù„ÛŒÙ„ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.";
                let sources = [];

                if (result.candidates && result.candidates[0]) {
                     text = result.candidates[0].content.parts[0].text;
                     const groundingMetadata = result.candidates[0].groundingMetadata;
                     if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(a => ({ uri: a.web?.uri, title: a.web?.title }))
                            .filter(s => s.uri && s.title);
                     }
                } else if (result.error) {
                    text = `Ø®Ø·Ø§ÛŒ API: ${result.error.message || 'Unknown API Error'}`;
                }
                
                const el = document.getElementById(loadingId);
                if(el) el.remove();
                
                addChatMessage(text, 'ai', false, sources);

            } catch (error) {
                console.error("RADSAN AI Request Failed. Review Network or API Key:", error);
                const el = document.getElementById(loadingId);
                if(el) el.remove();
                
                // Truncate error message for cleaner display
                const errorMessage = error && error.message 
                    ? `(Ú©Ø¯ Ø®Ø·Ø§: ${error.message.substring(0, 50)})` 
                    : '(Ø®Ø·Ø§: Ø´Ø¨Ú©Ù‡ ÛŒØ§ API Key)';

                addChatMessage(`
                    <div class="p-4 bg-red-900/40 rounded-lg border border-red-500/50">
                        <p class="font-bold text-red-300">ğŸš¨ Ø®Ø·Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</p>
                        <p class="text-sm text-red-400 mt-2">
                            Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù‡Ø³ØªÙ‡ ØªØ­Ù„ÛŒÙ„ÛŒ RADSAN Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯Ù‡ Ø§Ø³Øª. 
                            Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ù†Ù…Ø§ÛŒÛŒØ¯. 
                            <span class="text-red-500 block mt-1 dir-ltr">${errorMessage}</span>
                        </p>
                    </div>
                `, 'ai');
            }
        }

        function addChatMessage(message, sender, isLoading = false, sources = []) {
            const container = document.getElementById('chat-messages');
            const isUser = sender === 'user';
            const id = 'msg-' + Date.now();
            const align = isUser ? 'items-end' : 'items-start';
            const bg = isUser ? 'bg-yellow-600/20 rounded-tl-xl' : 'bg-white/5 rounded-tr-xl';
            
            let content = isLoading 
                ? '<div class="flex items-center space-x-2 dir-ltr"><div class="w-2 h-2 bg-yellow-400 rounded-full animate-bounce delay-100"></div><div class="w-2 h-2 bg-yellow-400 rounded-full animate-bounce delay-200"></div><div class="w-2 h-2 bg-yellow-400 rounded-full animate-bounce delay-300"></div></div>' 
                : `<div class="chat-message-content">${message}</div>`;

            // Add sources if available
            if (!isUser && sources.length > 0) {
                 const uniqueSources = Array.from(new Map(sources.map(item => [item['uri'], item])).values()).slice(0, 3);
                 content += `<div class="text-[10px] mt-3 text-gray-500 border-t border-white/10 pt-2 text-justify dir-ltr">
                    <b>Ù…Ù†Ø§Ø¨Ø¹:</b><br>` + uniqueSources.map((src, index) => 
                        `<a href="${src.uri}" target="_blank" class="block truncate hover:text-yellow-400 transition">${index + 1}. ${src.title}</a>`
                    ).join('') + `</div>`;
            }

            // The main message box
            const html = `
                <div class="flex ${align} mb-4" id="${id}">
                    <!-- Applied max-w-[95%] here to allow wrapping -->
                    <div class="max-w-[95%] p-4 rounded-xl ${bg} shadow-md border border-white/5 text-sm leading-7">
                        ${content}
                    </div>
                </div>
            `;
            container.innerHTML += html;
            container.scrollTop = container.scrollHeight;
            return id;
        }

        function toggleAccordion(id) {
            const c = document.getElementById(id+'-content');
            const i = document.getElementById(id+'-icon');
            c.classList.toggle('hidden');
            i.style.transform = c.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
        }
        document.getElementById('theme-selector').addEventListener('change', (e) => { document.body.className = `${e.target.value} min-h-screen relative text-right`; updateChart(CONFIG.defaultSymbol); });
        
        window.onload = function() {
            initThreeJS();
            if (typeof TradingView !== 'undefined') updateChart(CONFIG.defaultSymbol);
            else setTimeout(() => updateChart(CONFIG.defaultSymbol), 1000); 
            
            handleSoftRefresh();
            setInterval(handleSoftRefresh, CONFIG.apiRefreshRate);
            showStatusMessage("Ø¨Ù‡ Ø±Ø§Ø¯Ø³Ø§Ù† ØªØ­Ù„ÛŒÙ„ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!", 'info');
        };
    </script>
</body>
</html>


